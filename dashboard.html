<script src="https://cdn.plot.ly/plotly-latest.min.js"></script>
<script>
// ---------- helpers ----------
function marginToDecimal(val) {
    if (!val) return 0;
    const clean = String(val).replace("%", "");
    const num = Number(clean);
    if (isNaN(num)) return 0;
    return num / 100;
}

function getMonthName(dateStr) {
    if (!dateStr) return "";
    const parts = String(dateStr).split("-");
    let d;
    if (parts.length === 3) {
        const day   = parseInt(parts[0], 10);
        const month = parseInt(parts[1], 10) - 1;
        const year  = parseInt(parts[2], 10);
        d = new Date(year, month, day);
    } else {
        d = new Date(dateStr);
    }
    if (isNaN(d)) return "";
    const months = ["Jan","Feb","Mar","Apr","May","Jun",
                    "Jul","Aug","Sep","Oct","Nov","Dec"];
    return months[d.getMonth()];
}

let rawData = [];

// Load Data.csv with header row exactly as in your file [file:15]
Plotly.d3.csv("Data.csv", function(err, data) {
    if (err) {
        console.log("Error loading Data.csv", err);
        document.body.insertAdjacentHTML(
            "beforeend",
            "<p style='color:red'>Could not load Data.csv from the same folder as dashboard.html.</p>"
        );
        return;
    }

    // Map each row using the header names
    rawData = data.map(row => ({
        Region: row["Region"],
        State: row["State"],
        Product: row["Beverage Brand"],
        InvoiceDate: row["Invoice Date"],
        Month: getMonthName(row["Invoice Date"]),
        UnitsSold: Number(row["Units Sold"] || 0),
        TotalSales: Number(row["Total Sales"] || 0),
        OperatingProfit: Number(row["Operating Profit"] || 0),
        OperatingMargin: marginToDecimal(row["Operating Margin"])
    }));

    initFilters();
    updateDashboard();
    attachFilterEvents();
});

function initFilters() {
    const regionSel  = document.getElementById("regionFilter");
    const productSel = document.getElementById("productFilter");
    const periodSel  = document.getElementById("periodFilter");

    const regions  = Array.from(new Set(rawData.map(d => d.Region))).sort();
    const products = Array.from(new Set(rawData.map(d => d.Product))).sort();
    const months   = Array.from(new Set(rawData.map(d => d.Month)))
        .filter(m => m)
        .sort((a,b) => ["Jan","Feb","Mar","Apr","May","Jun","Jul","Aug","Sep","Oct","Nov","Dec"].indexOf(a)
                     - ["Jan","Feb","Mar","Apr","May","Jun","Jul","Aug","Sep","Oct","Nov","Dec"].indexOf(b));

    regions.forEach(r => {
        const opt = document.createElement("option");
        opt.value = r;
        opt.textContent = r;
        regionSel.appendChild(opt);
    });

    products.forEach(p => {
        const opt = document.createElement("option");
        opt.value = p;
        opt.textContent = p;
        productSel.appendChild(opt);
    });

    months.forEach(m => {
        const opt = document.createElement("option");
        opt.value = m;
        opt.textContent = m;
        periodSel.appendChild(opt);
    });
}

function attachFilterEvents() {
    document.getElementById("regionFilter").addEventListener("change", updateDashboard);
    document.getElementById("productFilter").addEventListener("change", updateDashboard);
    document.getElementById("periodFilter").addEventListener("change", updateDashboard);
}

function getFilteredData() {
    const region  = document.getElementById("regionFilter").value;
    const product = document.getElementById("productFilter").value;
    const period  = document.getElementById("periodFilter").value;

    return rawData.filter(d =>
        (region  === "All" || d.Region  === region) &&
        (product === "All" || d
